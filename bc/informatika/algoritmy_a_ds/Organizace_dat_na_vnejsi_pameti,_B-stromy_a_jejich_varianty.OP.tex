
\subsection{Organizace dat na vnìjší pamìti, B-stromy a jejich varianty}


\subsubsection*{Vnìjší pamì}

\begin{e}{Definice}{0}{Vnìjší pamì}
\emph{Vnìjší pamì} je úloištì dat (pamìové médium), u kterého je rychlost naèítání dat zpravidla nízká a pøístup k nim ne úplnì pøímı (záleí na uspoøádání dat na médiu), ne-li pouze sekvenèní (oproti vnitøní pamìti s rychlım náhodnım pøístupem a menší kapacitou). Pøíkladem vnìjší pamìti je pevnı disk nebo magnetická páska.

\emph{Magnetické pásky} poskytují vysokou kapacitu, ale nízkou rychlost a pouze sekvenèní pøístup. Pro jejich kapacitu je dùleitá hustota záznamu, potøebují meziblokové mezery pro vyrovnání nepøesnosti pøetáèení pásky.

\emph{Pevné disky} umoòují pøímı pøístup, ale jeho rychlost není vdy stejná. Ovlivòuje ji fyzická vzdálenost dat -- pevnı disk má nìkolik \emph{válcù}, na nich jsou uloeny jednotlivé datové \emph{stopy}. K válcùm pøísluší \emph{ètecí hlavy} (je jich stejnì jako válcù, ale pohybují se všechny souèasnì, take mùe v 1 okamiku èíst jen jedna). Disky jsou vìtšinou rozdìleny na \emph{sektory} -- nejmenší jednotku dat, kterou je moné naèíst nebo uloit (zpravidla jednotky KB). Pro rychlost pøístupu k datùm jsou dùleité tyto velièiny (vırobcem diskù jsou zpravidla udávány prùmìrné hodnoty):
\begin{pitemize}
    \item \emph{seek} ($s$) -- pøesun na jinou stopu, dnes zpravidla kolem 4-8~ms
    \item \emph{(average) rotational delay} ($r$) -- otoèení válcù -- 1 pùlotáèka, pro nejèastìjší 7200rpm disk je to cca 4~ms
    \item \emph{block transfer time} ($btt$) -- doba pøenesení 1 bloku po sbìrnici, na ATA/100 disku se 4~KB bloky teoreticky 0.04~ms
\end{pitemize}
Pokud jsou data umístìna na disku za sebou sekvenènì, rychlost jejich naètení je mnohem vyšší ne pøi náhodném rozmístìní, protoe není tøeba provádìt pøesuny mezi stopami a otáèení válcù navíc.
\end{e}

\begin{e}{Pøíklad}{0}{0}
\emph{Jak vypadá naètení 1~MB dat z pevného disku?} Pøedpokládejme, e na 1 stopu se vejde 512~KB a 1 blok má 4~KB. Jsou-li data umístìna na disku sekvenènì, potøebuji pro naètení 1~MB dat najít první blok a potom èíst dvì celé stopy (2 otáèky), tj. celkem $s+r+(2\cdot2r)$ (a pøenos po sbìrnici lze zanedbat, protoe probíhá zároveò se ètením). Pokud jsou data na disku náhodnì rozprostøena, potøebuji celkem 256-krát najít blok a naèíst ho: $256\cdot(s+r+btt)$, take operace trvá a 100-krát déle.
\end{e}


\subsubsection*{Soubor}

\begin{e}{Definice}{0}{Záznam, klíè}
\emph{(Logickı) záznam} je jednotka dat (napø. v databázi), má \emph{atributy} (z nich kadı má jméno a doménu -- povolenou mnoinu hodnot). Logickému záznamu v reprezentaci na disku odpovídá \emph{fyzickı záznam} (nìjaké délky $R$ -- pevné nebo promìnné), kterı navíc mùe obsahovat ještì další data -- oddìlovaèe, ukazatele, hlavièky. 

\emph{Klíè} je mnoina atributù, která jednoznaènì identifikuje záznam; proti tomu \emph{vyhledávací klíè} je mnoina atributù, pro kterou lze nalézt mnoinu odpovídajících záznamù. Vyhledávací klíèe jsou tøí druhù: hodnotovı (\uv{obyèejné} hodnoty nìkterıch atributù), hašovanı a relativní (pøímo pozice v souboru).
\end{e}

\begin{e}{Definice}{0}{Soubor}
(Homogenní) \emph{soubor} je multimnoina záznamù. Fyzicky na vnìjší pamìti je organizován do \emph{blokù (stránek)} (velikosti $B$, typicky nìkolika KB) -- hl. jednotkou pøenosu dat mezi vnitøní a vnìjší pamìtí. Pomìr velikosti záznamu k velikosti bloku ($B/R$) se nazıvá \emph{blokovací faktor} ($\lfloor b\rfloor$). Záznamy mohou bıt rozprostøeny i pøes nìkolik stránek, nebo mùe bıt pouze jeden záznam na 1 stránku; ideální (ale ne vdy dosaitelné) je, pokud beze zbytku zaplòují stránky. Na souboru jsou definovány operace se záznamy: \emph{insert, delete, update} a \emph{fetch}.
\end{e}

\begin{e}{Definice}{0}{Dotaz}
\emph{Dotaz} je kadá funkce, která kadému svému argumentu pøiøadí odpovídající mnoinu záznamù ze souboru (\uv{totální vyèíslitelná funkce definovaná na souboru}). Dotazy mohou bıt tìchto typù:
\begin{pitemize}
    \item Naètení všech záznamù ({\tt SELECT * FROM tabulka})
    \item Na úplnou shodu ({\tt SELECT * FROM tabulka WHERE sloupec1 = 'hodnota' AND sloupec2 = 'hodnota'} pro tabulku se 2 sloupci -- dány jsou všechny atributy)
    \item Na èásteènou shodu\\({\tt SELECT * FROM tabulka WHERE sloupec1 = 'hodnota'} pro tabulku se 2 sloupci -- zadaná je jen èást atributù)
    \item Na intervalovou shodu (èásteènou nebo úplnou) ({\tt SELECT * FROM tabulka WHERE sloupec1 > 'hodnota'})
\end{pitemize}
U souborù se sleduje rychlost provedení tìchto operací.
\end{e}


\subsubsection*{Statické metody organizace souboru}

\begin{e}{Definice}{0}{Schéma organizace souboru}
\emph{Schéma organizace souboru} je popis logické pamìové struktury, do ní lze zobrazit logickı soubor, spolu s algoritmy operací nad touto strukturou. Ta je obvykle tvoøena z logickıch stránek (blokù pevné délky) a mùe popisovat více provázanıch log. souborù, z nich \emph{primární soubor} je ten, kterı obsahuje uivatelská data. Operace definované nad schématem org. souboru jsou kromì operací nad soubory ještì \emph{build, reorganization, open} a \emph{close}.

Proti nìmu stojí \emph{fyzické schéma souboru} -- struktura nad fyzickımi soubory, nejblíe hardwaru je \emph{implementaèní schéma souboru}.

Zajištìní \emph{Vyváenosti struktury} znamená zajištìní omezení cesty pøi vyhledávání nìjakım vırazem (zaruèení asymptotické sloitosti), navíc zaruèení rovnomìrnosti zaplnìní struktury -- \emph{faktor naplnìní stránek}. Schémata, která splòují obì podmínky, se nazıvají \emph{dynamická}, ostatní jsou oznaèována jako \emph{statická}.
\end{e}

\begin{e}{Poznámka}{0}{Èasové odhady}
Pro schémata organizace souborù se poèítají èasové odhady provedení jednotlivıch operací -- jednodušších, jako je pøístup k záznamu ($T_F$), \emph{rewrite} -- pøepis bìhem 1 otáèky disku ($T_{RW}$), pøíp. sekvenèní ètení; dále i sloitìjších jako vyhledání záznamu, pøidání, smazání a úprava záznamu, reorganizace struktury nebo naètení celého souboru.
\end{e}

\begin{obecne}{Hromada (neuspoøádanı sekvenèní soubor)}
\emph{Hromada(heap)} je naprosto nejjednodušší schéma organizace souboru, kdy jsou záznamy v souboru jen náhodnì seøazeny za sebou. Èasová sloitost vyhledávání je $O(n)$, pokud $n$ je poèet záznamù. Jde o \emph{nehomogenní soubor}, kde záznamy obvykle nemají pevnou délku. 
\end{obecne}

\begin{obecne}{Uspoøádanı sekvenèní soubor}
V \emph{uspoøádaném sekvenèním souboru} jsou záznamy øazeny podle klíèe. Aktualizované záznamy se umístí do zvláštního souboru a a pøi další operaci \uv{reorganization} jsou pøidány do primárního. Sloitost nalezení záznamu je také $O(n)$, ale pokud se hledá podle klíèe, podle kterého jsou záznamy seøazeny, a navíc je soubor na médiu s pøímım pøístupem, sníí se na $O(\log n)$.
\end{obecne}

\begin{obecne}{Index-sekvenèní soubor}
Toto schéma uvauje primární soubor jako sekvenèní, uspoøádanı podle primárního klíèe. Nad ním je pak vytvoøen (tøeba i víceúrovòovı) \emph{index}. Ten sestává ze seznamu èísel stránek a minimálních hodnot klíèe jim odpovídajících záznamù. Pokud má index víc úrovní, provádí se pro vyšší úrovnì to samé na blocích indexù úrovnì o 1 niší. Nejvyšší úroveò indexu se obvykle vejde do 1 bloku, tzv. \emph{master}. 

Poèet potøebnıch úrovní pro $n$ záznamù se dá spoèítat jako $\lceil\log_p\frac{n}{\lfloor b\rfloor}\rceil$, kde $p=\lfloor\frac{B}{V+P}\rfloor$ pøi velikosti klíèe $V$ a pointeru na stránku $P$. Problémem je pøidávání novıch záznamù, kdy se tyto øetìzí za sebe v tzv. \emph{oblasti pøeteèení} (kadı z nich má pointer na další záznam v oblasti pøeteèení). Pro oddálení nutnosti vkládání do oblasti pøeteèení lze iniciálnì bloky plnit na ménì ne 100\%.
\end{obecne}


\begin{obecne}{Indexovanı soubor}
\emph{Indexovanı soubor} znamená primární soubor plus indexy pro rùzné vyhledávací klíèe. Neindexují se u stránky, ale pøímo záznamy, a proto primární soubor nemusí bıt nutnì setøídìnı. Index mùe bıt podobnı jako u index-sekvenèního souboru, pro záznamy se stejnım klíèem je ale vhodné, aby byly na všech úrovních indexu kromì poslední slouèené. Pøi aktualizaci se nepouívá oblast pøeteèení, mìní se pouze index.

Existuje i nìkolik dalších variant indexù. Pro zmenšení nároènosti dotazù na kombinovanou èásteènou shodu se pouívá \emph{kombinovanı index} pro více atributù, u nìho je ale nutné pøedem zjistit na které kombinace atributù budou èasto pokládány dotazy, a pro takové kombinace tento index teprve vytvoøit. \emph{Clusterovanı index} zaruèuje, e záznamy s podobnou hodnotou indexovaného atributu jsou blízko sebe v primárním souboru -- napø. pokud je primární soubor podle tohoto atributu setøídìny. Tento index lze pouít jen pro 1 atribut. 

\emph{Bitové mapy} se dají pouít jako index pro atributy s malou doménou (mnoinou monıch hodnot) -- pro kadou hodnotu této domény se vyrobí vektor bitù stejné délky, jako je poèet záznamu v primárním souboru, kde jednièka na $i$-té pozici indikuje, e $i$-tı záznam má právì tuto hodnotu atributu. To umoòuje jednoduché provádìní booleovskıch dotazù na tento atribut. Vektory bitù navíc lze komprimovat, take nezabírají tolik místa.
\end{obecne}

\begin{obecne}{Soubor s pøímım pøístupem}
V tomto schématu jsou záznamy v primárním souboru (\uv{adresovém prostoru} velikosti $M$) rozptıleny pomocí \emph{hashovací funkce}. Èasto se pouívá funkce $h=k\mod M'$, kde $M'$ je nejbliší prvoèíslo menší ne velikost adresového prostoru. Hashovací funkcí se urèuje buï jenom èíslo stránky, nebo i relativní pozice v ní. Pøi hashování vznikají kolize, které se dají øešit \emph{otevøenım adresováním} (øetìzením kolizních záznamù za sebe), \emph{rehashováním} (další funkcí) nebo pouitím \emph{oblasti pøeteèení}. Snaha je vìtšinou umístit kolizní záznamy do stejné stránky. 

Pokud je hashovací funkce prostá, jedná se o \emph{perfektní hashování}. Toho ale v praxi vlastnì nelze dosáhnout, take se tento vıraz pouívá i pro oznaèení stavu, kdy je pro nalezení záznamu potøeba nejvıš $O(1)$ pøístupù k médiu. Oèekávaná délka øetìzce kolizí pøi poètu $N$ záznamù v prostoru velikosti $M$ je $1/(1-\frac{N}{M})$.
\end{obecne}

\subsubsection*{Tøídìní na vnìjší pamìti}

\begin{e}{Algoritmus}{0}{Tøídìní sléváním (Mergesort)}
Tento algoritmus se pouívá pro tøídìní dat, která se nevejdou do vnitøní pamìti. Dá se pouít i pøi sekvenèním pøístupu k datovım souborùm. Nejjednodušší verze bez bufferù vypadá takto:
\begin{pitemize}
    \item inicializace: na zaèátku kadého kroku data rozdìlí do 2 souborù
    \item naète 2 záznamy, kadı z jednoho souboru a porovná je
    \item ve správném poøadí je zapíše do vıstupního souboru, ze vstupního souboru si naète další dva
    \item v prvním kroku získám uspoøádané posloupnosti délky 2; v dalších krocích vdy porovnám naètené prvky, zapíšu menší z nich a ze souboru odkud tento pocházel si naètu další, take získám vdy uspoøádané posloupnosti dvojnásobné délky ne v pøedchozím kroku
    \item po $\lceil\log n\rceil$ krocích je soubor s $n$ záznamy setøídìnı.
\end{pitemize}
Vylepšení se dosáhne napø. pøímo støídavım zapisováním vıstupu do 2 souborù, kdy se zbavím nutnosti na zaèátku kadého kroku data dìlit, nebo pouitím více souborù najednou. Je taky moné vyuít rostoucích posloupností prvkù, které se v souboru nacházejí ji pøed zapoèetím tøídìní.
\end{e}

\begin{e}{Algoritmus}{0}{Tøídìní haldou}
Pro tøídìní ve vnitøní pamìti se pouívá algoritmus \emph{tøídìní haldou (heapsort)}, kterı se dá zakomponovat do vylepšení tøídìní sléváním (viz níe). Jeho základem je datová struktura \emph{halda} (konkrétnì maximální halda, max-heap), reprezentovaná jako pole záznamù, na kterém je binární stromová struktura: záznam $k$ má vdy vyšší klíè ne jeho dva synové, nacházející se na pozicích $2k+1$ a $2k+2$ pøi èíslování od $0$ (pokud tato pozice není vìtší ne velikost haldy, v opaèném pøípadì záznam nemá syny). Na pozici $0$ se tak nachází záznam s nejvyšším klíèem. Postup tøídìní je následovnı:
\begin{pitemize}
    \item nejvìtší prvek (z pozice $0$) se prohodí s tím prvkem, jeho èíslo pozice odpovídá aktuální velikosti haldy
    \item velikost haldy se zmenší o 1
    \item dokud neplatí podmínka, e klíè prvku získaného z konce haldy je vìtší ne oba klíèe jeho synù, prohazuje se tento se synem s vìtším klíèem (a tak posouvá v haldì dál)
    \item toto se opakuje, dokud je velikost haldy vìtší ne 1, odzadu tak v poli vzniká setøídìná posloupnost
\end{pitemize}
Èasová sloitost algoritmu je $O(n\cdot\log n)$ pro pole záznamù velikosti $n$.
\end{e}

\begin{e}{Algoritmus}{0}{$n$-cestné tøídìní}
Pokud mám k dispozici ve vnitøní pamìti $n+1$ stránek, mohu postupovat následovnì:
\begin{pitemize}
    \item v 1. kroku naèíst do pamìti $n$ stránek
    \item ty setøídit pomocí heapsortu (nebo i quicksortu apod.) a získat tak delší setøídìné úseky (\emph{bìhy})
    \item slévat vdy $n$ nejkratších bìhù (pomocí mergesortu) a vytváøet tak jeden bìh
    \item toto opakovat, dokud existuje více ne 1 bìh.
\end{pitemize}
Èas. sloitost pro $M$ stránek v souboru je $O(2M\lceil\log_n M/n\rceil)$.
\end{e}

\begin{e}{Algoritmus}{0}{Dvojitá halda}
Delší bìhy pøi slévání se dají vytváøet pomocí dvojité haldy -- v pamìti mám dvì haldy z celkem $n$ prvkù, opakovanì z první haldy odebírám a zapisuji minimální prvek do vıstupního bìhu a naèítám další prvek, pokud ten je vìtší ne minimum haldy, vloím ho do prvé haldy, pokud je menší, vloím ho do druhé haldy, která vzniká od konce mého pole. A se první halda vyèerpá, pouiji druhou a zaènu novı bìh. Toto v nejhorším pøípadì dává stejnou velikost bìhù jako obyèejná halda, prùmìrnì je 2x lepší.
\end{e}


\subsubsection*{B-stromy}

\begin{e}{Definice}{0}{B-strom}
B-strom øádu $m$ je vıškovì vyváenı strom, kterı má násl. vlastnosti:
\begin{penumerate}
    \item Koøen má minimálnì 2 syny, pokud není sám listem.
    \item Kadı jinı uzel kromì listù má nejménì $\lceil\frac{m}{2}\rceil$ a nejvíce $m$ synù a vdy o 1 ménì dat. záznamù (listy mají jen datové záznamy).
    \item Klíèe všech záznamù v $i$-tém podstromu uzlu $A$ jsou vìtší ne klíè $i$-tého záznamu uzlu $A$ a menší nebo rovny klíèi $i+1$-tého záznamu.
    \item všechny \emph{vìtve} (cesty od koøene k listu) jsou stejnì dlouhé.
\end{penumerate}
Variantou jsou \emph{redundantní B-stromy}, kdy všechna data jsou umístìna v listech, vnitøní uzly obsahují pouze vyhledávací klíèe. Jiná monost je pouití pouze klíèe a odkazu na celı záznam, místo vkládání kompletních záznamù do stromu.
\end{e}

\begin{e}{Algoritmus}{0}{Operace na B-stromì}
\emph{Vyhledávání} v B-stromech podle klíèe se provádí jednoduchım prùchodem do hloubky.

\emph{Vkládání} probíhá tak, e se najde místo, kam záznam vloit, pokud není uzel plnı, prostì se záznam vloí, jinak se uzel rozštìpí, pùlka prvkù se dá vlevo, pùlka vpravo a prostøední se vloí („mezi nì“) do otce. Pokud v otci není místo, pokraèuje se stejnım zpùsobem a do koøene, kde se pøípadnì vytvoøí novı uzel a udìlá se z nìj koøen.

\emph{Odebírání} prvkù je opaènı postup, v pøípadì podteèení uzlu (zùstane v nìm ménì ne $\lceil\frac{m}{2}\rceil$ synù) musím pøebírat data od sousedních uzlù nebo slévat. V redundantních B-stromech není nutné pøi mazání odstraòovat vyhledávací klíè z vnitøních uzlù -- prvek s touto hodnotou se ve stromì u nebude nacházet, ale vyhledávat podle jeho klíèe je dál moné.
\par
Lepší naplnìnosti uzlù za cenu sníení rychlosti se dá dosáhnout pomocí \emph{vyvaování stránek} -- pøi pøeteèení stránky nejdøív kontroluji, jestli nejsou volné sousední; pokud ano, pøerozdìlím data a upravím klíèe. Podobnì je moné postupovat pøi mazání (i pokud není tøeba slévat).
\par
Dalším vylepšením je odloení štìpení -- ke kadému listu nebo skupinì listù pøísluší stránka pøeteèení, kam se vkládají záznamy, které se u do daného místa nevejdou. Nové vkládání a štìpení je provedeno a tehdy, jestlie se stránka pøeteèení i všechny pøíslušné uzly naplní. Takto upravenı strom s více ne 1 úrovní má vdy všechny listy zaplnìné (za pøedpokladu nepouití mazání). Pøísluší-li stránky pøeteèení skupinám listù, musím je pøi mazání a pøidávání listù takté štìpit a slévat.
\end{e}

\begin{e}{Definice}{0}{B+ stromy}
\emph{B+ stromy} jsou mírnım vylepšením B-stromù pro zrychlení intervalovıch dotazù: všechny uzly ve stejné úrovni (a nebo jenom listy) jsou spojeny do spojového seznamu (moná je jednosmìrná i obousmìrná varianta).
\end{e}

\begin{e}{Definice}{0}{B* stromy}
\emph{B* stromy} (øádu $m$) jsou úpravou B-stromù na základì vyvaování stránek. Druhá podmínka B-stromù se upraví tak, e kadı uzel kromì koøene a listù má minimálnì $\lceil(2m-1)/3\rceil$ a max. $m$ synù a odpovídající poèet dat. záznamù. Listy mají opìt jen stejné rozmezí pro poèet dat. záznamù. Pøi vkládání prvkù se stìpení odkládá opìt do té doby, dokud nejsou plní i sourozenci daného listu; potom se štìpí buï 2 listy do 3, nebo 3 do 4 (buï s pomocí jednoho nebo dvou sousedních sourozencù). Odebírání podobnì zahrnuje slévání 3 uzlù do 2 (nebo 4 do 3). Pøi obém lze ve sloitìjší variantì zapojit ještì více uzlù.
\end{e}

\begin{e}{Definice}{0}{Prefixové stromy (Trie)}
Tento druh stromù slouí k uloení dat, klíèovanıch øetìzci. Jde o redundantní stromy, data jsou uloena a v listech; vyhledávací klíèe jsou vdy co nejkratší moné prefixy øetìzcù, nutné k odlišení uzlù. Celé hodnoty klíèù (a další data) se nacházejí a v listech. Pøi vkládání a štìpení stránek se nìjakou heuristikou hledá nejkratší prefix, kterı by vzniklé stránky oddìlil. Vylepšená varianta neukládá u synù pøedponu klíèe, kterou má rodiè -- je to pamìovì efektivnìjší, ale zvyšuje vıpoèetní nároky.
\end{e}

\begin{e}{Definice}{0}{Stromy s promìnnou délkou záznamu}
Jde o modifikaci B-stromu, která umoòuje do nìj uloit záznamy promìnné délky. Listy se neštìpí podle poètu záznamù, ale zhruba na poloviny podle velikosti dat. Druhá podmínka B-stromù se upraví následovnì: celková délka záznamù v jednom uzlu je minimálnì $\lceil B/2\rceil$ a maximálnì $B$ (kde $B$ je nìjaká zvolená hodnota, vìtš. velikost stránky na disku). Existuje i varianta s podmínkou \uv{$2/3$}, jako mají B*-stromy.

Problémem této struktury je tendence delších záznamù ke stoupání ke koøeni, èím se sniuje arita záznamù. To se øeší hledáním dìlícího záznamu s min. délkou tak, aby vzniklé uzly splòovaly podmínky stromu (a je to docela nároèné). Navíc štìpení je sloitìjší -- 1 stránka se mùe štìpit na 3 (vloím-li hodnì dlouhı záznam), mùe dojít ke zmenšení stromu pøi vloení apod., bìnì se pouívá obecnı algoritmus nahrazování, jeho speciální pøípady jsou insert a delete.
\end{e}


\begin{e}{Definice}{0}{Vícerozmìrné B-stromy}
Pouívají se, je-li potøeba efektivnì hledat záznamy podle více atributù. Jde o propojenou mnoinu stromù. K jednotlivım atributùm pøíslušejí prvky pole odkazù na seznamy stromù, ve kterıch se podle danıch atributù dá hledat. Pro první atribut je potøeba jen 1 strom, v nìm je pro kadı klíè odkaz na celı strom 2. atributu (pro další je to podobné). Stromy stejného atributu jsou ve spojovém seznamu. Mohu hledat všechny záznamy, pro které znám hodnoty všech atributù, nebo jenom jejich podmnoinu -- vyaduje to projít více stromù, ale není tøeba mnoinovıch operací.
\end{e}
