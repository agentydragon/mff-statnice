\subsection{Vstupní a vıstupní zaøízení, ukládání a pøenos dat}

Zaøízení mají rùzné charakteristiky:
\begin{pitemize}
    \item \textbf{druh}~-- blokové (disk, síová karta), znakové (klávesnice, myš)
    \item \textbf{pøístup}~-- sekvenèní (datová páska), náhodnı (hdd, cd)
    \item \textbf{komunikace}~-- synchronní (pracuje s daty na ádost~-- disk), asynchronní (\uv{nevyádaná} data~-- síová karta)
    \item \textbf{sdílení}~-- sdílené (preemptivní, lze odebrat~-- síová karta (po multiplexu OS)), vyhrazené (nepreemptivní~-- tiskárna, sdílení se realizuje pøes \textbf{spooling} - frontou). Reálnì se rozdíly stírají.
    \item \textbf{rychlost} (od nìkolika Bps po GBps)
    \item \textbf{smìr dat}~-- R/W, R/O (CD-ROM), W/O (tiskárna) 
\end{pitemize}

\begin{e}{Propojovací systémy}{0}{0}
Dìlí se na \textbf{dvoubodové spoje} (vztah 1:1), jde napø. o pøímé spojení porty, køíovı pøepínaè, kde není nutná ádná adresace. Druhou moností jsou \textbf{vícebodové spoje}, kde více úèastníkù sdílí pøenosové médium jako napø. sbìrnice nebo pøi broadcastingu.
\end{e}

\textbf{Procesor} mùe pøistupovat k I/O zaøízením dvìma zpùsoby:
\begin{pitemize}
    \item \textbf{port-mapped I/O} -- speciální adresovı port CPU, kterı má i speciální instrukce pro práci (IN, OUT) s I/O zaøízením, která také mají vlastní adresovı prostor (buï pøímo vlastní sbìrnici, nebo extra I/O pinem), díky tomu se také øíká \uv{isolated I/O},
    \item \textbf{memory-mapped I/O} -- pamìové mapování, kterı mapuje I/O zaøízení pøímo do fyzické pamìti, kterou tak sdílí s ostatními daty, tato èást pamìti mùe bıt vyhrazená trvale nebo i jen doèasnì. Zaøízení poslouchá na adresové sbìrnici, aby vìdìlo, kdy má pracovat (odpovídat, ...).
\end{pitemize}

  \begin{center}
    \includegraphics[width=8cm]{informatika/operacne_systemy_a_hw/obrazky/bus_north_south_bridge.png}
  \end{center}

\begin{e}{Sbìrnice}{0}{0}
Sbìrnice je sada vodièù propojující více zaøízení. Vodièe jsou oddìlené pro øízení (poadavky, potvrzení, typ dat) a data (pøenos dat, adresování). Vıhodou je univerzálnost a nízká cena, nevıhodami pak omezení délkou a dané v dùsledku pouívání rozmanitıch zaøízení, také potenciální \uv{bottleneck}.\\
Transakce na sbìrnici zaèíná poadavkem (vyslání pøíkazu a adresy cíle), na kterı musí cíl odpovìdìt potvrzením, naèe následuje pøenos dat mezi úèastníky \textbf{master/initiator} (kteøí posílají poadavek) a \textbf{slave/target}, kteøí posílají/pøijímají data.\\
\textbf{øízení} -- \textbf{synchronní} (podle hodin, jednodušší, rychlejší, ale omezená délka sbìrnice a stejnı èas všem) vs. \textbf{asynchronní} (obecnìjší, sloitìjší, zato bez omezení délky, ale s niší rychlostí, napø. USB, FireWire)\\
\textbf{pøidìlování} -- \textbf{centralizované} (master ádá a èeká na pøidìlení, které pøidìluje arbitr podle priority a fairness, master po provedení operace dá arbitrovi vìdìt, e je sbìrnice opìt volná) vs. \textbf{distribuované}, které mùe bıt kolizní nebo zaloené na \uv{samovıbìru}.
\end{e}

\begin{figure}[h]
  \centering
  \subfloat[polling]{\label{fig:bus_polling}\includegraphics[width=0.49\textwidth]{informatika/operacne_systemy_a_hw/obrazky/bus_polling.png}} \hfill
  \subfloat[prioritní zøetìzení, daisy chain]{\label{fig:bus_daisy_chain}\includegraphics[width=0.49\textwidth]{informatika/operacne_systemy_a_hw/obrazky/bus_daisy_chain.png}} \hfill
  \subfloat[nezávislé ádosti]{\label{fig:bus_independent}\includegraphics[width=7cm]{informatika/operacne_systemy_a_hw/obrazky/bus_independent.png}}
    \caption{centralizované pøidìlování}
  \label{fig:bus_centralizovane_pridelovani}
\end{figure}
Informace o stavu zaøízení mùe CPU získávat:
\begin{pitemize}
    \item \textbf{polling}~-- aktivní èekání na zmìnu zaøízení (program periodicky kontroluje stav), pro pomalá zaøízení vzniká znaèná reie
    \item \textbf{interrupt-driven I/O}~-- asynchronní pøerušení od zaøízení, které samo signalizuje zmìnu stavu, na co reaguje obsluná rutina. CPU ovšem není na pøerušení pøipraven, tak musí uloit stav programu $\rightarrow$ stojí to èas. CPU musí podporovat tuto signalizaci pøerušení, identifikovat zdroj pøerušení, vybrat správnou obslunou rutinu. Systém musí zajistit doruèení pøerušení k CPU a dále øadiè jejich podle priority urèí jejich poøadí (mùe jich bıt více ne má CPU vstupù). Prùbìh:
    \begin{penumerate}
    \item     Vnìjší zaøízení vyvolá poadavek o pøerušení
    \item			I/O rozhraní vyšle signál IRQ na øadiè pøerušení (na port IRQ 2)
    \item     Øadiè pøerušení vygeneruje signál INTR – „nìkdo“ ádá o pøerušení a vyšle ho k procesoru.
    \item     Procesor se na základì maskování rozhodne obslouit pøerušení a signálem INTA se zeptá, jaké zaøízení ádá o pøerušení.
    \item     Øadiè pøerušení identifikuje zaøízení, které ádá o pøerušení a odešle èíslo typu pøerušení k procesoru
    \item     Procesor uloí stavové informace o právì zpracovávaném programu do zásobníku.
    \item     Podle èísla typu pøíchozího pøerušení nalezne ve vektoru pøerušení adresu pøíslušného obsluného podprogramu.
    \item     Vyhledá obslunı podprogram obsluhy pøerušení v pamìti a vykoná ho.
    \item     Po provedení obsluného programu opìt obnoví uloené stavové informace ze zásobníku a pøerušenı program pokraèuje dál.
\end{penumerate}
    
\end{pitemize}

Pøenos dat mezi zaøízením a CPU/pamìtí:
\begin{penumerate}
    \item \textbf{PIO (Programmed I/O)}~-- data pøenášena za úèasti CPU (plnì zamìstnán), pøenos realizován cyklem v programu, rychlı pøenos, ale neefektivní vyuití CPU, pak pøišlo DMA
    \item \textbf{DMA (Direct Memory Access)}~-- zaøízení si samo øídí pøístup na sbìrnici a pøenáší data z/do pamìti bez úèasti CPU; po skonèení pøenosu pøerušení (oznámení o dokonèení) napø, pøenos dat mezi HDD a RAM
\end{penumerate}

\begin{e}{Bus mastering}{0}{0}
Slouí pro pøenos dat mezi zaøízením a pamìtí nebo mezi dvìma zaøízeními. Jde o to, e sbìrnici mùe øídit (zaèít transakci, bıt masterem) libovolnı úèastník (CPU vnímán jako jeden z nich), stále je nutné pøenos \emph{nastavit} z programu.
\end{e}

\subsubsection*{DMA}
CPU nastaví pøenos a nechá DMA pracovat, a je operace dokonèena, pošle se pøerušení, tedy mezitím mùe CPU pracovat jinde. DMA øadiè je obvod pro øízení pøenosù na sbìrnici mezi pamìtí a zaøízeními nebo i pouze v pamìti. U multiprocesorù se uívá i k pøenosu dat mezi jádry. Dále bìnì u pevnıch diskù, grafickıch, zvukovıch a síovıch karet. DMA øadiè obsahuje registry, do kterıch mùe CPU zapisovat nastavení pøenosu (adresa v pamìti, poèet bytù, smìr r/w, jaké zaøízení) -- tomu se øíká \textbf{burst mode}, ve kterém vystaèí jeden adresovı cyklus na celı blok dat. Dále se vyuívá pøi pøenosu dat do/z více nesouvislıch bufferù (\textbf{scatter/gather}, také vektorové I/O).

\begin{e}{Práce øadièe DMA}{0}{0}
\begin{pitemize}
    \item generuje adresy pamìti a periferie, generuje øídící signály pro ètení/zápis
    \item generuje signály pro procesor, aby zajistil, e procesor nepøistupuje (nezapisuje) na sbìrnici
    \item øadiè sám se chová jako periferie
    \item program nastavuje parametry pøenosu, tj. odkud se bude pøenášet, kam, a kolik (2 èítaèe, kanál DMA)
    \item zaøízení pøipojena na kanál DMA, pøi pøenosu je cílové zaøízení aktivováno øadièem, nikoliv vystavením adresy   
\end{pitemize}
\end{e}

\begin{e}{Posloupnost událostí}{0}{0}
Èísla pøed událostí odpovídají èíslùm na obrázku níe.
\begin{pitemize}
    \item program nastaví øadiè a periferii a povolí pøenos
    \item[(1)] aktivací signálu DREQx periferie poádá øadiè DMA o pøenos slova z/do pamìti
    \item øadiè DMA zkontroluje nastavení kanálu vyhodnotí prioritu ádosti
    \item[(2)] aktivací signálu HOLD øadiè DMA poádá CPU o pøidìlení sbìrnice
    \item[(3)] pokud CPU nepotøebuje sbìrnici, odpojí se od sbìrnice a signalizuje HLDA
      \subitem - CPU poøád testuje HOLD na zaèátku strojového cyklu
    \item[(4)] po pøijetí HLDA øadiè pøipraví sbìrnici pro pøenos
    \subitem - vystaví adresu v pamìti a øídící signály pro ètení/zápis z/do pamìti/periferie
    \item[(5)] øadiè DMA aktivuje signál DACKx, kterım vyzve periferii k vystavení/pøeètení dat na/ze sbìrnice
    \item[(7)] v závislosti na reimu buï pøenos konèí, nebo pokraèuje dalším slovem dokud je DREQx aktivní
    \item pøi posledním slovì øadiè aktivuje signál EOP
    \item[(8)] pøi ukonèení pøenosu øadiè uvolní signál HOLD
    \item[(9)] procesor uvolní HLDA a pøipojí se ke sbìrnici
\end{pitemize}
\begin{figure}[h]
  \centering
  \label{fig:dma_block_transfer}
  \includegraphics[width=17cm]{informatika/operacne_systemy_a_hw/obrazky/dma_block_transfer.png}
%  \caption{DMA burst mode}
\end{figure}
\end{e}

Problémy u DMA spoèívají v odstínìní CPU od pamìti, co mùe vyvolat \textbf{pamìovou koherenci}, slušnì øeèeno pomocí DMA obejdeme cache CPU, kde mohou bıt aktuálnìjší hodnoty ne v pamìti, a tudí máme problém Houstone. Øeší se to tím, e procesor sleduje, na jaké adresy se pøistupuje a pokud tam padne nìjaká, kterou má v cache, tak to zaène øešit.

\begin{figure}[h]
  \centering
  \label{fig:dma_memory_incoherency}
  \includegraphics[width=12cm]{informatika/operacne_systemy_a_hw/obrazky/pametova_koherence.png}
  \caption{pamìová koherence}
\end{figure}

Cíle I/O software:
\begin{pitemize}
    \item \textbf{Nezávislost zaøízení}~-- programy nemusí dopøedu vìdìt, s jakım pøesnì zaøízením budou pracovat~-- je jedno jestli pracuji se souborem na pevném disku, disketì nebo na CD-ROM
    \item \textbf{Jednotné pojmenování} (na UNIXu /dev)
    \item \textbf{Pøipojení (mount)}~-- èasté u vymìnitelnıch zaøízení (disketa); moné i u pevnıch zaøízení (disk); nutné pro správnou funkci cache OS
    \item \textbf{Obsluha chyb}~-- v mnoha pøípadech oprava bez vìdomí uivatele (velmi èasto zpùsobeno právì uivatelem)
\end{pitemize}

\begin{reportN}{Bulej + Yaghob}
zapisal som vyse strany, ale to co ma yaghob na slidoch a to co je vo vypracovanom ucebnom texte ich ani trochu nezaujimalo. zaujimal ich popis DMA a preruseni, pricom sa pytali ako to presne funguje - chceli popisat instrukcie ako to moze prebiehat, ako sa to presne implementuje apod., co som bohuzial vobec nevedel
\end{reportN}

\begin{reportN}{Bulej} Prenos dat z disku do operacni pameti. Pøekvapivì dobrı vısledek, nicménì den pøedtím jsem si èetl o DMA, take bych to mìl vìdìt ejo :-) Chtìl by prej ještì vìdìt, e to, co sedí na sbìrnici a øídí ten pøenos, se ovládá z procesoru tak, e v tom jsou nìjakı registry, do kterejch se hodí instrukce, a taky e se naètou data z disku do diskovı cache, pak se vyvolá pøerušení, a pak se teprva ty data nìjak dostanou do RAMky, tøebas tim DMA nebo jinejma zpùsobama (a jakejma, pochopitelnì).
\end{reportN}
