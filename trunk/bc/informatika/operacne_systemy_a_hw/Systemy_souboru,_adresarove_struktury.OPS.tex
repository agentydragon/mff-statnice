\subsection{Systémy souborù, adresáøové struktury}

\begin{e}{Definice}{0}{Systémy souborù}
  \begin{pitemize}
    \item Poskytují jednotné rozhraní pro ètení a ukládání dat z/do pomocnıch pamìtí
(sekundární, terciální).
    \item Skrıvají povahu zaøízení, na kterém jsou umístìny. Aplikace s tímto zaøízením mohou
pracovat pouze pøes rozhraní souborového systému, tedy mohou provádìt pouze operace
nad soubory a adresáøi. Nemohou ale èíst èi zapisovat pøímo z/do zaøízení pod
souborovım systémem. Pro aplikace nemusí bıt viditelné, zda je oním zaøízením pevnı
disk, nìjaké vzdálené síové úloištì èi operaèní pamì (RAM dsk).Administrátoøi
samozøejmì mohou èíst i pøímo ze zaøízení.
    \item Souborové systémy se obvykle pouívají na pevnıch diskách, CD/DVD a dalších
médiích, která neumoòují pøistupovat k datùm pøímo po bajtu (mezi námi, ani procesor
to pøi pøístupu do RAM nedìlá), ale po blocích pevné velikosti – sektorech. Obvyklá
velikost u dnešních pevnıch diskù je 512 B u CD/DVD jsem vidìl 2 KB. Souborové
systémy jsou navreny právì tak, aby s takovımi zaøízeními efektivnì pracovaly.
    \item \textbf{Velikost blokù}: souborové systémy obvykle nepracují pøímo se sektory, ale definují si
vlastní bloky, velké obvykle nìkolik clusterù (4, 8, 16, 32). Tìmto blokùm se na Unixu
øíká prostì blocks, na Windows clustery (èesky alokaèní jednotky). Souborové
systémy umí ukládat data pouze s granularitou danou velikostí jednoho bloku.
  \begin{pitemize}
    \item Pøíliš malé bloky jsou sice šetrné k plıtvání místa „na konci souborù“ (pokud data
souboru skonèí uprostøed bloku, moc volného místa se nevyplıtvá – malá interní
fragmentace). Malıch blokù musí bıt ale velké mnoství, aby pokryly celou oblast
média, take interní datové struktury (a tedy i èasová reie) jsou vìtší.
    \item Velké bloky znamenají jednodušší datové struktury, ale vìtší interní fragmentaci
(plıtvání volného místa).
  \end{pitemize}
\end{pitemize}  
\end{e}
    \begin{center}
      \includegraphics[height=7cm]{informatika/operacne_systemy_a_hw/obrazky/disc.png}
    \end{center}   
\begin{e}{Definice}{0}{soubor}
  Perzistentní úloištì dat v pomocné pamìti. Kadı soubor je obvykle tvoøen
jedním nebo více bloky dat, která obsahuje, a metadaty s rùznımi informacemi.
  \begin{pitemize}
    \item pojmenování souboru (umoòuje uivateli pøístup k jeho datùm;
    pøesná pravidla pojmenování urèuje OS - malá vs. velká písmenka,
    speciální znaky, délka jména, pøípony a jejich vıznam)
    \item atributy souborù (opìt urèuje OS) - jméno, typ, umístìní, velikost, ochrana, èasy, vlastník, \dots
    \item struktura souborù - sekvence bajtù / sekvence záznamù / strom
    \item typy souborù - bìné soubory, adresáøe (systémové soubory vytváøející strukturu souborového systému), speciální soubory (znakové/blokové, soft linky)
\item \textbf{Operace} - CREATE, OPEN, CLOSE, READ, WRITE, SEEK, DELETE, MAP, UNMAP,
RENAME (nemusí bıt pøítomna, pokud je jméno souboru uloeno jen v jeho
rodièovském adresáøi, jak tomu je v EXT), LOCK, UNLOCK..
    \item  \textbf{Øídké soubory (sparse files)} - Rozumí se jím soubor obsahující velké shluky nulovıch bajtù, kterı je v souborovém systému uloen úspornım zpùsobem tuto jeho vlastnost vyuívajícím. To je zajištìno tak, e jsou místo velkıch „dìr“ (tj. shlukù nul) na médium zaznamenána pouze struèná metadata, v kterıch je uloena délka a pozice dìr. Nenulové èásti souboru jsou na médium zapsány obvyklım zpùsobem a za pomoci metadat z nich operaèní systém dokáe za bìhu zpìt konstruovat pùvodní dlouhı soubor vyplnìnı mnoha nulami. Øídké soubory tedy mohou najít své uplatnìní napøíklad pro
reprezentaci obrazù diskù virtuálních poèítaèù.
    \begin{center}
      \includegraphics[height=7cm]{informatika/operacne_systemy_a_hw/obrazky/sparse-files.png}
    \end{center}    
  \end{pitemize}
\end{e}



\begin{obecne}{Adresáøe}
  \begin{pitemize}
    \item vìtšinou zvláštní typ souboru
    \item operace nad adresáøi - CREATE, DELETE, LIST, RENAME
    \item koøen, aktuální adresáø, absolutní/relativní cesta
    \item hierarchická struktura 
    \begin{pitemize}
      \item \emph{strom}~-- jednoznaèné pojmenování (cesta)
      \item \emph{DAG}~-- víceznaèné pojmenování, ale nejsou cykly
      \item \emph{obecnı graf}~-- cykly vytváøí problém pøi prohledávání
    \end{pitemize}
    \item implementace adresáøù - záznamy pevné velikosti, spojovı seznam, B-stromy 
  \end{pitemize}
\end{obecne}

\begin{obecne}{Co musí filesystém umìt?}
musí splòovat 3 vìci: 
\begin{pitemize}
\item \emph{správu souborù} (kde jsou, jak velké) 
\item \emph{správu adresáøù} (pøevod jméno $\leftrightarrow$ id) (nìkdy to dìlá jinı prostøedek, dnes vìtš. umí FS sám), 
\item \emph{správu volného místa}. nìkdy mohou bıt i další (odolnost proti vıpadkùm) 
\end{pitemize}
\end{obecne}

\begin{obecne}{Linky}
  \begin{pitemize}
    \item \textbf{Hard link}~-- Na jedna data souboru se odkazuje z rùznıch poloek v adresáøích (na urovni FS) $\rightarrow$ mìní FS ze stromu na DAG \footnote{Hard linky se obvykle nepovolují vytváøet na adresáøe vzhledem k monému
vzniku neádoucích krunic. Ty jsou neádoucí, protoe pak mohou vznikat
entity, u kterıch nelze poèítáním referencí odhalit, e mohou bıt smazané. Je
nutné pouít garbage collection.}
\item \textbf{Soft link}~-- Speciální soubor, kterı obsahuje jméno souboru (na urovni OS)\footnote{Soft Linky mohou odkazovat jak na soubory, tak na adresáøe. Protoe se jedná pouze o
jmenné aliasy (nepropojují se samotné objekty), ani vznik krunic neznamená
ádné problémy.}
  \end{pitemize}
\end{obecne}

\begin{obecne}{MBR} 
A master boot record (MBR) is a type of boot sector. It consists of a sequence of 512 bytes located at the first sector of a data storage device such as a hard disk. May be used for one or more of the following:
  \begin{pitemize}
    \item Holding a partition table which describes the partitions of a storage device. In this context the boot sector may also be known as a partition sector.
    \item Bootstrapping an operating system. The BIOS built into a PC-compatible computer loads the MBR from the storage device and passes execution to machine code instructions at the beginning of the MBR.
    \item Uniquely identifying individual disk media, with a 32-bit disk signature, even though it may never be used by the operating system.
  \end{pitemize}
\end{obecne}


\begin{obecne}{FAT} 
  \begin{pitemize}
    \item System souboru FAT rozdeluje disk na dve vyznacne casti - samotnou tabulku FAT (ta je zpravidla ve dvou kopiich) a datovou oblast. Datova oblast je rozdelena na clustery (napriklad po 4096 bajtech) a FAT tabulka ma tolik polozek, kolik ma datova oblast clusteru (1:1).
    \item \textbf{FAT tabulka}~-- pole záznamù\footnote{12 bitovıch na FAT12, 16 bitovıch
na FAT16, 32 bitovıch na FAT32}, obsahuje èislo dalsiho clusteru v øadì nebo speciální záznamy (oznaèení end of clusterchain, bad cluster, reserved cluster a free cluster)
    \item \textbf{Alokace souboru}~-- jednosmìrnı spojovı seznam, kadı blok ukazuje na další pøes FAT tabulku    
    \begin{center}
      \includegraphics[height=5cm]{informatika/operacne_systemy_a_hw/obrazky/FAT16.png}
    \end{center}      
    \subitem - Kdyz je nejaky cluster volny, v prislusne polozce FAT je 0. Tedy 
kdyz chci najit volne misto, tak staci najit libovolnou polozku FAT, 
ktera je 0, odpovidajici cluster pak je volny.    
    \item Adresare i soubory jsou ulozeny stejne. Rozdily mezi adresari a soubory (krom daneho atributu) neexistuji. Z hlediska ulozeni na disku je adresar proste soubor, jehoz obsahem jsou adresarove polozky. Vyjimka viz root adresar. 
    \item \textbf{Root adresáø}~-- V root adresari, i ve vsech ostatnich adresarich, jsou 
proste jen za sebou ulozeny polozky. Kazda polozka obsahuje jmeno 
souboru nebo adresare, ke kteremu se vztahuje, atributy rozlisujici 
napriklad prave adresare od souboru, delku, prvni cluster, atd.
    \subitem - Root directory ma pevnou velikost ve FAT 12/16
    \subitem - Polozky root adresare, ktere nejsou pouzite, jsou oznacene jako prazdne 
(ale porad patri do root adresare, aby velikost zustala konstantni). 
Pridani pak pouzije nekterou prazdnou polozku. Pokud jsou jiz vsechny 
polozky plne, dalsi nelze pridat.
    \item \textbf{Vyhledávání souboru}~--  Postupne ... v root adresari se najde prvni podadresar cesty, v nem se 
najde druhy a tak dale. (tzn. lineární struktura)
    \item Adresarova struktura je ulozena prave v jednotlivych adresarich. 
Napriklad, pokud je na disku soubor 
\\$C:\backslash FOO\backslash BAR\backslash SOUBOR.TXT$, tak v korenovem 
adresari bude polozka FOO s atributem indikujicim, ze se jedna o adresar 
a s cislem prvniho clusteru adresare FOO, rekneme ze 123. V clusteru 123 
pak budou polozky adresare FOO, mezi nimi bude podobne polozka BAR pro 
adresar BAR a cislem prvniho clusteru adresare BAR, rekneme 456. A v 
clusteru 456 budou polozky adresare BAR, mezi kterymi bude i polozka 
SOUBOR.TXT ...
    \item dnes se ni setkame ještì na flashkách a pamìovıch kartách                
    \item \textbf{nevyhody FAT}: 
    \subitem - velikost souboru max 4 GB  
    \subitem - svazky - FAT32 reálnì okolo 8TB (32kB clustery), nemá ale ochranu proti fragmentaci
    \subitem - práva - None of the various FAT-flavours has facilities for user-based access restrictions.
    \item \url{https://d3s.mff.cuni.cz/pipermail/osy/2005-June/000167.html}
    \item \url{http://en.wikipedia.org/wiki/File_Allocation_Table}
\end{pitemize}
\end{obecne}

\begin{obecne}{NTFS} 
  \begin{pitemize}
    \item Zase rozdìluje oddíl na dvì èásti tabulka MFT (jako soubor, ma ale pøiøazenou prázdnou oblast aby se pøi rùstu nefragmentovala) a datovou oblast.
    \item \textbf{Metafiles} - prvních cca 16 souboru jsou tzv. Metafiles, kadı se stará o nìco $\Rightarrow$ flexibilita napø. pri poskozenem povrchu        
    \subitem pøíklady souboru: \$MFT, \$MFTmirr (MFT a zalozni kopie uprostred disku),\$LogFile (zurnalovaci soubor),\$. (root directory),\$Bitmap (bitove pole volneho mista) atd...             
    \item \textbf{urnál} -- Operace s diskem se provadeji jako Transakce, take napø. pokud pri zapisu souboru FS zjisti ze cluster je fyz. vadnı, celou trasakci rollbackuje a pusti ji jinde znovu.
    \item Další vlastnosti ktere ma navic: sifrovani, komprese, hardlinky (soubor je fyz. na disku jednou a ma vic zaznamu v MFT)
    \item \textbf{MFT tabulka} -- obdoba FAT, vsechna metadata o souborech (jmeno,datum,prava) jsou ulozena v MFT - omoznuje pridavat ficury, muze obsahovat primo i male soubory nebo odkazy na clustery (zaèínající cluster + poèet)\footnote{tzv. run listy}
    \begin{center}
      \includegraphics[height=5cm]{informatika/operacne_systemy_a_hw/obrazky/mft-entry-extent.gif}
    \end{center}     
    \item Vnitøní struktura adresáøe se realizuje B+Stromem (lexikograficky setrideny) zase pokud je malej zustane v MFT pokud je vetsi je v clusteru a v MFT je jenom koøenová èást B+Stromu.     
    \begin{center}
      \includegraphics[height=5cm]{informatika/operacne_systemy_a_hw/obrazky/ntfs.png}
    \end{center}           
    \item \url{http://pages.cs.wisc.edu/~bart/537/lecturenotes/s26.html}    
    \item \url{http://www.digit-life.com/articles/ntfs/}
    \item \url{http://www.pcguide.com/ref/hdd/file/ntfs/archSector-c.html}
    \item \url{http://cs.wikipedia.org/wiki/NTFS}    
    \item \url{http://ixbtlabs.com/articles/ntfs/}
    \end{pitemize}
    
\end{obecne}

\begin{obecne}{ext2} 
  \begin{pitemize} 
    \item Prostor je u ext2 rozdìlen do blokù, ty jsou rozdìleny do skupin (Block Groups) typicky jeden soubor se drí v jedné skupinì (redukce fragmentace). Kadá skupina obsahuje kopii superbloku (obsahuje kritické informace pro boot systemu) a Group Descriptors Table\footnote{ Early versions of the ext2 file system to make copies of the superblock at the beginning of each block group. This led to heavy losses of disk space, so that later the number of backups superblock has been reduced, and for their placement have been allocated a group of blocks 0, 1, 3, 5 and 7.}, bitmapu datovıch blokù, bitmapu inodes, Inode tabulku a nakonec datové bloky. 
    \begin{center}
      \includegraphics[height=13cm]{informatika/operacne_systemy_a_hw/obrazky/ext2-all.png}
    \end{center}     
    \item \textbf{inode} -- kadı soubor nebo sloka (zde také soubor) je reprezentována jako inode (v inode tabulce), obsahuje práva, velikost a hlavnì pointery na datové bloky (12pointerù na pøímı odkaz a další na stromovou strukturu), sloky
obsahují v datovıch blocích linked list inodes které obsahují a jejich názvy (samotnı inode název souboru neobsahuje!)        
    \item Proc se porad pouziva - kvùli rychlosti
    \item urnálování zavedeno u ext3              
    \item \url{http://www.nongnu.org/ext2-doc/ext2.pdf}
    \item \url{http://homepage.smc.edu/morgan_david/cs40/analyze-ext2.htm}    
    \item \url{http://www.science.unitn.it/~fiorella/guidelinux/tlk/node95.html}

    \end{pitemize}
    
\end{obecne}
\begin{obecne}{Shrnutí}
\\
\begin{tabular}{| 1 | p{4cm} | p{4cm} | p{4cm} | p{4cm} | }
\hline          
    & správa souborù & správa adresáøù & správa volného místa & další \\
\hline           
\hline             
  FAT & lineární spojovı seznam (pøes FAT) & nesetøídìné pole & v FAT, dá se øíct bitmapa & neumí nic pokroèilého: linky, zabezpeèení,relokaci poškozenıch clusterù...  \\
\hline            
  NTFS & runlisty (odkazy na clustery jsou v MFT) & B*strom (neredundatní) & bitmapa & kvóty, zabezp., transakce, linky, relokace souborù, šifrování, øídké soubory \\
\hline            
  ext2 & index(12+3 pointery), ext4–runlist & linked list, ext4–2-level hashing & bitmapy & zabezpeèení, linky, v základu neumí kompresi a šifrování\\
\hline  
\end{tabular}
\end{obecne}
\begin{obecne}{Algoritmy plnìní poadavkù disku}
\begin{pitemize}
\item Disk o struktuøe souborového systému nic neví, dostává pouze poadavky na zápis èi ètení blokù dat z urèitıch míst.
\item \textbf{Shortest seek first} (z nevyøízenıch poadavkù na ètení/zápis dat beru ty, které jsou
nejblíe aktuální pozici hlavy, tedy mají nejmenší délku posunu (seek), tedy nejniší
seek time. Problém je, e nìkteré poadavky tak nemusím obslouit vùbec (napøíklad
mi poøád pøichází poadavky ètení nìkde uprostøed disku, a tak se poøád pohybuju
tam... ale pár poadavkù na ètení okrajù disku tedy vùbec nevyøídím, protoe je tam
dlouhı seek).
\item \textbf{Vıtah (elevator)}. Obsluhuji poadavky pouze v jednom „smìru,“ tím se napøíklad
stále vzdaluji od støedu disku. Jakmile v daném smìru nejsou ji ádné poadavky na
vyøízení, obrátím smìr a zase pomalu smìøuju ke støedu disku).
\item \textbf{jednosmìrnı vıtah} (poøád jezdí jedním smìrem, vdy na konci se posune na nejniší
cylindr s poadavkem).
  \end{pitemize}
\end{obecne}

\begin{obecne}{RAID (Redundant Array of Inexpensive Disks)}
  \begin{pitemize}
    \item JBOD (Just a Bunch of Disks)
    \item RAID 0~-- striping, ádná redundance
    \item RAID 1~-- mirroring, redundance
    \item RAID 0+1~-- mirroring a striping
    \item RAID 2~-- 7-bitovı paritní Hammingùv kód
    \item RAID 3~-- 1 paritní disk, po bitech na disky
    \item RAID 4~-- 1 paritní disk a striping
    \item RAID 5~-- distribuovaná parita a striping
    \item RAID 6~-- distribuovaná parita -- dvojitá P+Q, striping 
  \end{pitemize}
\end{obecne}
\begin{obecne}{Zdroje:}
  \begin{pitemize}
    \item http://www.jadro-windows.cz/
  \end{pitemize}    
\end{obecne}
\begin{reportN}{Galamboš} inode\end{reportN}
\begin{reportN}{Galamboš} Konkretni soubory system NTFS - tady jsem popletl jak vlastne pracuje FATka, o NTFS jsem mel tak jako povesechne informace, proste nic moc jsem nevedel, ale zase jsme si popovidali, byly mi vysvetleny me omyly a nakonec oka. 
Jinak je pravda, ze toho chce docela hodne a dopodrobna, ale kdyz clovek rekne, ze proste k tomuhle vic nesehnal a ze podrobnosti proste nevi, pobavi se o tom s Vami a vetsinou se to da dokupy. 
\end{reportN}
\begin{reportN}{Skopal} Zkoušel sám p. Skopal a jeliko jsem se FS uèil jako jednu z prvních otázek, v návalu dalších informací jsem toho mezitím dost zapomnìl. Popsal jsem jeden a pùl strany obecnımi vlastnostmi FS, co to je soubor, adresáø atd. Popsal jsem FAT, NTFS a ext2, a to dost struènì. Obecné vlastnosti ho nezajímaly, hned pøešel k FAT a jejím nevıhodám, otázky byly rychlé a dost podrobné, bylo vidìt, e to se mnou nebude mít jednoduché. Pak mìl otázky na NTFS, co má za spec. soubory, kdee je v systému implementován B-strom atd. K ext2 jsme se nedostali a na jedinou zmínku, a to je alokace souborù (ve FAT lineární struktura, v ext2 strom). Kdy poloil otázku na B-stromy v NTFS a po mojí tìce nejisté odpovìdi prohlásil, e mu to staèí a odešel, bylo mi jasné, e tohle nedopadne dobøe.
\end{reportN}
\begin{reportN}{Yaghob} Konkretni Filesystemy - no jeste pred dvema dny by to byla moje smrt, nastesti sem se na to vcera zameril a nasel si opravdu presne jak funguje FAT, NTFS a ext2. Nakonec z toho byly tri papiry, az jsem na sebe byl pysny U FAT bylo treba napsat, jak se to alokuje, jak vypada ta tabulka, jakou roli ma kor. adresar, jak jsou tam ulozeny adresare, soubory apod. U NTFS jsem popsal vlastnosti ktere to ma navic, jako zurnal, sifrovani a pak rozepsal MFT docela podrobne, zase jak se resi soubory, adresare. Veci jako jak jsou tam ulozeny jednotlivy volume, MBR atd po me nastesti nechtel U ext2 je asi dulezite pochopit jak ten inode funguje, jak je to tam ve skupinach bloku, co je to superblok. Prislo mi, ze hlavni duraz je kladeny na to, at se vi, jak jsou tam ulozeny adresare a soubory. Pak prislo par otazek typu, jake jsou omezeni FATky, (velikost souboru, partitiony, ale hlavne se po me chtelo slyset: prava), kde se s tim dnes setkame (flashky, pametove karty) - na ty jsem dosel po vyjmenovani win98, mobilu, zkusil jsem i routery a ind. pocitace a nakonec me uspesne dovedl ke spravne odpovedi U ext2 prislo, proc se to porad jeste pouziva,kdyz je to tak stary FS - jedine co me napadlo byla rychlost - spravne
\end{reportN}
